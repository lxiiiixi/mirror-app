> 在这里记录一些很细节的开发过程中容易遗漏的小需求，对应代码中的特定位置，需要注意修改什么，在这里做一个简单的记录。

## 作品详情页 - 语言选择器对作品语言的切换

- **默认选中**：打开作品详情页时，选择器默认选中的是**当前全局语言**（i18n.resolvedLanguage / i18n.language），通过 `i18nLanguageToSelectValue` 转成与接口一致的 key（zh / en / zh_hant）。不再固定为英文。
- **不修改全局语言**：选择器只切换**当前作品**的展示语言（封面、标题、作者、简介等多语言字段），不调用 `i18n.changeLanguage`，不写 `localStorage['user-lang']`。状态由页面内 `contentLang` 维护，仅影响 `resolveLocalizedText(..., languageSelectValueToI18n(contentLang))` 的展示。
- **可选语言来自接口**：选项根据接口返回的**有内容的语言**展示。通过 `getAvailableContentLanguages(data)` 从 `work_name` / `work_cover_url` / `work_creator_name` / `work_description` 中收集至少有一个非空值的 key，传给 `LanguageSelect` 的 `availableLanguages`，只展示这些选项。
- **空内容回退**：展示时用 `resolveLocalizedText(value, languageSelectValueToI18n(contentLang))`；若当前选中语言对应内容为空字符串，`resolveLocalizedText` 内部会按优先级回退到第一个非空语言版本，避免出现空白。
- **数据加载后同步**：当作品接口数据加载完成后，若当前 `contentLang` 不在本次接口的可用语言列表中，会自动将 `contentLang` 设为第一个可用语言，保证选择器与展示一致。

涉及文件：

- `apps/web/src/components/WorkDetail/languageSelectUtils.ts`：`i18nLanguageToSelectValue`、`languageSelectValueToI18n`、`getAvailableContentLanguages`、`getLanguageOptions`
- `apps/web/src/components/WorkDetail/LanguageSelect.tsx`：受控 value + `availableLanguages`，不再依赖 i18n
- `apps/web/src/components/WorkDetail/ProductCover.tsx`：接收 `contentLang`、`onContentLangChange`、`availableLanguages`，不再调用 i18n
- `apps/web/src/pages/WorkDetail.tsx`：`contentLang` 状态、用 `contentLang` 解析封面/标题/作者/简介并传给 ProductCover，数据加载后校正 `contentLang`

---

## 推广链接点击统计（/work/track）

- **时机**：应用**首屏加载**时，若当前 URL 带有 `invite_uid` 或 `invite_code`，上报一次「推广链接点击」（不限于作品详情页，任意带邀请参数的落地页都会统计）。
- **接口**：`GET /arts/work/track`，query 传 `invite_uid`、`invite_code`（与 arts-app 一致），用于统计邀请带来的访问与转化。
- **行为**：仅在该次加载时上报一次（用 ref 标记已上报，避免重复）；无邀请参数则不请求。不依赖登录态（接口 auth: none）。

涉及文件：

- `apps/web/src/hooks/useTrackPromoClick.ts`：Hook，根据 `useLocation().search` 解析 `invite_uid` / `invite_code`，有则调用 `artsApiClient.work.trackPromoClick(...)`，只上报一次。
- `apps/web/src/App.tsx`：在根组件中调用 `useTrackPromoClick()`，保证一进入应用就判断。
- `packages/api`：`WorkTrackPromoParams` 支持 `invite_uid`、`invite_code`（与 `promo_code` 并存兼容）

---

## 邀请绑定（注册邀请 + 作品邀请）

- **两种链接**：  
  - **注册邀请**：链接带 `invite_uid`（如 `...?invite_uid=463559014261824`），登录时传 `invite_uid_code`。  
  - **作品邀请**：链接带 `invite_code`（如 `...?invite_code=00000X`），登录时传 `work_invite_code`。
- **流程**：每次进入应用时根据当前 URL 解析 `invite_uid` / `invite_code`，**写入本地缓存**（避免刷新或跳转后丢失）；用户通过钱包或邮箱登录时从缓存读取并带上对应参数；**登录成功后清除缓存**，避免下次登录重复使用。
- **已登录用户**：若已是登录态，一般不再绑定；但 Solana 钱包会周期性调 `solanaWalletLogin` 做签名更新，此时若缓存中仍有作品邀请码，会一并带上（逻辑与未登录时一致，成功后清除）。
- **邮箱登录**：邀请码输入框会**自动填充**缓存中的 `work_invite_code` 或 `invite_uid`（优先作品码）；提交时以缓存为准传 `work_invite_code`、`invite_uid_code`，若无缓存则用用户输入作为 `work_invite_code`。

涉及文件：

- `apps/web/src/utils/inviteParams.ts`：缓存 key、`persistInviteParamsFromSearch`、`getPendingInviteParams`、`clearPendingInviteParams`
- `apps/web/src/hooks/usePersistInviteParams.ts`：在 App 内根据 `location.search` 持久化邀请参数
- `apps/web/src/App.tsx`：调用 `usePersistInviteParams()`
- `apps/web/src/hooks/useWallet.ts`：`signInWithWallet` 中读取 pending 并传 `work_invite_code` / `invite_uid_code`，登录成功后 `clearPendingInviteParams()`
- `apps/web/src/pages/EmailLogin.tsx`：初始 state 从 `getPendingInviteParams()` 填充邀请码输入框；提交时传双参数，成功后 `clearPendingInviteParams()`
