# 首页列表缓存与详情页首屏遮挡问题复盘

## 1. 背景与问题描述

本次排查覆盖两个看似独立、但都与「路由切换 + 移动端视口行为」相关的问题：

1. 首页列表从详情页返回后，是否有缓存时效与刷新策略。
2. 从首页进入作品详情时，若浏览器顶部地址栏处于展开状态，详情页顶部会被遮挡。

---

## 2. 现象与复现路径

### 2.1 首页列表缓存/刷新

复现路径：

1. 打开首页，列表加载完成。
2. 点击任一作品进入详情。
3. 从详情返回首页。

观察：

- 列表通常不会立即重新请求，而是直接恢复原列表内容和滚动位置。
- 一段时间后（超过阈值）再次进入首页，才会触发重新拉取。

### 2.2 详情页顶部被地址栏遮挡

复现路径：

1. 在移动端浏览器（尤其 iOS Safari / Android Chrome）打开首页并向下滚动。
2. 保持浏览器地址栏处于展开或半展开状态。
3. 点击作品进入详情页。

观察：

- 详情页顶部内容（含顶部返回/操作区域）会有一部分被浏览器地址栏/安全区覆盖。

---

## 3. 根因分析

### 3.1 首页列表缓存策略（属于预期行为）

首页使用了本地内存态缓存（Zustand store），核心逻辑：

- 缓存字段：`items / total / page / hasMore / language / updatedAt / hasFetched`
- 缓存有效期：`5 * 60 * 1000`（5 分钟）
- 语言切换会参与缓存有效性判断（语言不同视为缓存失效）

因此从详情返回首页时，若缓存仍有效，则直接复用缓存，不会强制刷新。这是为了提升回跳体验与减少请求。

### 3.2 详情页遮挡问题（真实缺陷）

根因是两个因素叠加：

1. 详情页容器使用 `100vh` 语义（`min-h-screen`）时，在移动浏览器动态地址栏场景下，`vh` 与可视区域不完全一致。
2. 路由切到详情页时未显式回到顶部，可能继承此前滚动上下文，导致首屏定位异常。

当地址栏展开/收缩导致 visual viewport 变化时，顶部固定/绝对定位区域更容易出现“看起来被遮住”的问题。

---

## 4. 本次修复

### 4.1 详情页容器改为动态视口高度 + 顶部安全区

- 将详情页根容器改为 `min-h-[100dvh]`
- 增加 `paddingTop: max(env(safe-area-inset-top), 0px)`

目的：

- `dvh` 跟随动态可视区，避免地址栏变化造成布局错位。
- `safe-area-inset-top` 兜底刘海屏/状态栏区域，避免顶部内容侵入系统 UI。

### 4.2 进入详情页时强制回到页面顶部

在详情页挂载时执行：

- `window.scrollTo(0, 0)`

目的：

- 切断从首页滚动状态带来的首屏偏移。
- 保证详情页始终从顶部开始渲染，首屏视觉稳定。

---

## 5. 关键代码位置

1. 首页缓存判定（5 分钟 TTL）
- `apps/web/src/pages/Home.tsx`
- `apps/web/src/store/useHomeWorkListStore.ts`

2. 首页路由滚动保留
- `apps/web/src/App.tsx`（`preserveScrollKeys="/"`）

3. 详情页视口与安全区修复
- `apps/web/src/components/WorkDetail/Layouts.tsx`

4. 详情页进入时滚动复位
- `apps/web/src/pages/WorkDetail.tsx`

---

## 6. 核心原理总结

1. 列表页性能优化原则
- 「返回列表」优先用户连续性，优先复用缓存 + 还原滚动位置。
- 刷新时机应由 TTL、关键参数变化（语言/筛选条件）控制，而不是每次回跳都强刷。

2. 移动端视口适配原则
- 新页面优先使用 `dvh/svh`，不要盲目依赖 `100vh`。
- 所有首屏关键页面应考虑 `safe-area-inset-*`。

3. 路由切换稳定性原则
- 从可滚动列表进入详情页时，应显式定义“进入后滚动起点”。
- 不同 layout 容器之间切换（有/无外层滚动容器）要做滚动状态隔离。

---

## 7. 后续开发经验（Checklist）

### 7.1 列表页

1. 先明确缓存层级：内存缓存还是持久化缓存。
2. 显式定义 TTL 与失效条件（语言、筛选、登录态等）。
3. 列表回跳是否保留滚动位置必须在 PR 里写清楚。

### 7.2 详情页

1. 首屏容器优先 `min-height: 100dvh`。
2. 顶部交互区域默认预留 `safe-area-inset-top`。
3. 页面挂载时明确是否 `scrollTo(0, 0)`。

### 7.3 路由/布局层

1. 当页面在 `AppLayout` 内外切换时，必须测试滚动衔接。
2. 在 iOS Safari、Android Chrome 真机验证地址栏展开/收起场景。
3. 对“fixed/absolute 顶部元素 + 动态视口”的组合做专项回归。

---

## 8. 结论

- 首页列表“返回不立即刷新”是当前设计策略（5 分钟缓存 + 语言维度失效），不是 bug。
- 详情页顶部遮挡是移动端视口适配缺失导致的问题，已通过 `dvh + safe-area + 进入页滚动复位` 修复。
- 后续开发应把“缓存策略”和“移动视口适配”作为同等级别的基础能力，在需求阶段就明确，而不是上线后被动修补。
