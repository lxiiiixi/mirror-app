# 作品邀请逻辑梳理（Web）

> 本文档基于当前 `apps/web` 实现，梳理“作品邀请 + 新用户邀请”的完整前端行为与关键代码位置。

---

## 1. 参数定义与职责

当前邀请相关有 3 组参数，职责不同：

1. `invite_code` / `work_invite_code`
   - 含义：作品邀请码（6 位），用于作品签到链路。
   - 使用时机：`POST /arts/work/signIn`。
   - 说明：`invite_code` 与 `work_invite_code` 二选一，Web 当前统一传 `invite_code`。

2. `invite_uid` / `invite_uid_code`
   - 含义：邀请人 UID，用于邀请新用户（注册/登录绑定）。
   - 使用时机：登录接口（邮箱/钱包）。
   - URL 参数是 `invite_uid`，请求体参数是 `invite_uid_code`。

3. `club_invite`
   - 含义：推广页（Promotion/VIP）使用的参数，不属于作品签到邀请链路。

---

## 2. 邀请链接生成与复制（已改为携带 invite_uid）

### 2.1 标准作品邀请链接格式

当前生成格式：

```text
/works/detail?id={work_id}&invite_code={invite_code}&invite_uid={uid}
```

关键实现：

- `packages/utils/src/link.ts`
  - `getInviteLink(workId, inviteCode, inviteUid?)`
  - 当 `inviteUid` 存在时会自动拼接 `invite_uid`。

### 2.2 复制入口

1. 首页作品分享（X 分享文本里的链接）
   - 先调 `generateInviteCode`，取 `invite_code + uid`，再生成链接。
   - 文件：`apps/web/src/pages/Home.tsx`

2. 作品详情页空投区“邀请链接”显示与复制
   - 先调 `generateInviteCode`，把 `invite_code + uid` 生成到 `inviteUrl`。
   - 文件：`apps/web/src/components/WorkDetail/Layouts.tsx`

3. 作品详情页签到成功弹窗“Go Invite”
   - 复制前再次调 `generateInviteCode`，确保拿到最新 `uid` 后复制。
   - 文件：`apps/web/src/pages/WorkDetail.tsx`

4. 邀请列表弹窗里的提醒复制
   - 优先复制父组件传入的完整 `inviteUrl`（避免丢失 `invite_uid`）。
   - 文件：`apps/web/src/components/Modals/WorkDetailModals.tsx`

---

## 3. 邀请参数解析与本地缓存

### 3.1 解析入口

- 根组件 `App` 中每次路由变化都会执行：
  - `usePersistInviteParams()`
  - 文件：`apps/web/src/App.tsx`

### 3.2 解析规则

从 URL `search` 解析：

- `invite_uid` -> 存到 `mirror_pending_invite_uid`
- `invite_code` -> 存到 `mirror_pending_work_invite_code`

文件：

- `apps/web/src/utils/inviteParams.ts`
- `apps/web/src/hooks/usePersistInviteParams.ts`
- `apps/web/src/utils/localStorage.ts`

---

## 4. 未登录用户从邀请链接进入后的行为

示例链接：

```text
/works/detail?id=439&type=9&invite_uid=463559014261824&invite_code=000010
```

行为：

1. 页面加载时，`invite_uid` / `invite_code` 都会先缓存。
2. 用户点击签到时若未登录，会先弹登录。
3. 登录成功后，再走签到时会把作品邀请码带到 `signIn`。

---

## 5. 登录链路（新用户邀请）

### 5.1 邮箱登录

请求体只带：

- `invite_uid_code`（来自缓存 `invite_uid` 或输入框）

不再带：

- `work_invite_code`

文件：`apps/web/src/pages/EmailLogin.tsx`

### 5.2 钱包登录

请求体只带：

- `invite_uid_code`（来自缓存）

不再带：

- `work_invite_code`

文件：`apps/web/src/hooks/useWallet.ts`

### 5.3 登录成功后的清理

- 仅清理 `pendingInviteUid`（`invite_uid`）
- 保留 `pendingWorkInviteCode`，留给后续 `signIn` 使用

文件：`apps/web/src/utils/inviteParams.ts`

### 5.4 邀请链接场景下的登录回跳（新增）

当用户在作品详情页（例如带 `invite_code` / `invite_uid` 的邀请链接）触发登录弹窗并选择邮箱登录时：

1. 跳转到邮箱页时会附带 `redirect` 参数（当前页面完整路径）。
2. 该跳转会额外标记 `backOnSuccess=true`（通过路由 state），用于登录成功后优先走 `history back`。
3. 邮箱登录成功后：
   - 若存在 `backOnSuccess` 且可回退，执行返回上一路由（通常是作品详情页）。
   - 否则才按 `redirect` 回跳；若 `redirect` 非法（非站内相对路径）则回退到 `/`。

这样可以保证“未登录用户从邀请链接进入 -> 登录 -> 回到原详情页签到”，且从详情页返回时不会再回到邮箱登录页。

涉及文件：

- `apps/web/src/App.tsx`（打开邮箱登录时拼接 `redirect`）
- `apps/web/src/pages/EmailLogin.tsx`（登录成功后按 `redirect` 回跳）

---

## 6. 签到链路（作品邀请）

调用接口：

- `POST /arts/work/signIn`

请求体：

```json
{
  "work_id": 214,
  "invite_code": "000004"
}
```

前端取值优先级：

1. 当前 URL 的 `invite_code`
2. 本地缓存 `pendingWorkInviteCode`

调用点：

1. 作品详情页主签到按钮
   - 文件：`apps/web/src/components/WorkDetail/Layouts.tsx`

2. 邀请列表弹窗中“自己签到”
   - 文件：`apps/web/src/components/Modals/WorkDetailModals.tsx`

签到成功后：

- 清理 `pendingWorkInviteCode`，避免后续误带。

---

## 7. 与后端约定（当前前端遵循）

1. 不再单独调用 `applyInviteCode`。
2. 前端在 `signIn` 中可选带 `invite_code`（或 `work_invite_code`）。
3. 不带邀请码时，`signIn` 行为与旧逻辑一致。
4. 邀请新用户链路通过 `invite_uid`（登录时传 `invite_uid_code`）生效。

---

## 8. 关键代码索引

- 邀请参数缓存：
  - `apps/web/src/utils/inviteParams.ts`
  - `apps/web/src/hooks/usePersistInviteParams.ts`
- 登录消费 `invite_uid`：
  - `apps/web/src/pages/EmailLogin.tsx`
  - `apps/web/src/hooks/useWallet.ts`
- 签到消费 `invite_code`：
  - `apps/web/src/components/WorkDetail/Layouts.tsx`
  - `apps/web/src/components/Modals/WorkDetailModals.tsx`
- 邀请链接生成（含 `invite_uid`）：
  - `packages/utils/src/link.ts`
  - `apps/web/src/pages/Home.tsx`
  - `apps/web/src/pages/WorkDetail.tsx`

---

## 9. 自测建议

1. 未登录打开带 `invite_uid` + `invite_code` 的作品链接，登录后签到成功。
2. 抓包确认登录请求仅带 `invite_uid_code`，不带 `work_invite_code`。
3. 抓包确认 `signIn` 请求带 `invite_code`。
4. 签到成功后刷新页面，`pendingWorkInviteCode` 已被清理。
5. 从首页/作品详情复制链接，确认 URL 含 `invite_uid`。
