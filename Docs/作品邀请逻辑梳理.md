# 作品邀请逻辑梳理（Web）

> 本文档基于当前 `apps/web` 实现，梳理“作品邀请 + Club 邀请（登录绑定）”的完整前端行为与关键代码位置。

---

## 1. 总览

当前前端有两条独立邀请关系：

1. 作品邀请（`invite_code`）
- 用途：作品签到前绑定邀请关系。
- URL 参数：`invite_code`。
- 消费接口：`POST /arts/work/signIn`（请求体可选 `invite_code`）。

2. Club 邀请（`club_invite`）
- 用途：新用户登录绑定邀请关系。
- URL 参数：`club_invite`。
- 消费接口：邮箱/钱包登录接口（请求体字段 `invite_uid_code`）。

结论：
- 邀请链接生成不再需要携带 `invite_uid`（用户 ID）。
- 目前只有上述两条邀请链路，互不混用。

---

## 2. 作品邀请链路（`invite_code`）

### 2.1 邀请链接生成

标准格式：

```text
/works/detail?id={work_id}&invite_code={invite_code}
```

关键实现：

- `packages/utils/src/link.ts`
  - `getInviteLink(workId, inviteCode)`（仅拼接 `invite_code`）

生成入口：

1. 首页作品分享（X 分享文本内链接）
- 文件：`apps/web/src/pages/Home.tsx`

2. 作品详情页空投区（邀请链接展示/复制）
- 文件：`apps/web/src/components/WorkDetail/Layouts.tsx`

3. 作品详情页签到成功弹窗 `Go Invite`
- 文件：`apps/web/src/pages/WorkDetail.tsx`

4. 邀请列表弹窗提醒复制
- 文件：`apps/web/src/components/Modals/WorkDetailModals.tsx`

### 2.2 参数缓存

- URL `invite_code` 会缓存到 `mirror_pending_work_invite_code`。
- 入口：`usePersistInviteParams()`。

相关文件：

- `apps/web/src/hooks/usePersistInviteParams.ts`
- `apps/web/src/utils/inviteParams.ts`
- `apps/web/src/utils/localStorage.ts`

### 2.3 签到消费

调用：`POST /arts/work/signIn`

请求示例：

```json
{
  "work_id": 214,
  "invite_code": "000004"
}
```

前端取值优先级：

1. 当前 URL 的 `invite_code`
2. 本地缓存 `pendingWorkInviteCode`

成功后：

- 清理 `pendingWorkInviteCode`，避免后续误带。

调用点：

- `apps/web/src/components/WorkDetail/Layouts.tsx`
- `apps/web/src/components/Modals/WorkDetailModals.tsx`

---

## 3. Club 邀请链路（`club_invite` -> `invite_uid_code`）

### 3.1 邀请码来源

- 来源接口：`GET /arts/node/inviteInfo`
- 使用字段：`invite_code`

文件：`apps/web/src/pages/Promotion.tsx`

### 3.2 分享链接生成

标准格式：

```text
/?club_invite={invite_code}
```

说明：

- 点击 Share Link 复制的就是上述链接。
- 这里的 `invite_code`（来自 `/node/inviteInfo`）就是登录接口使用的 `invite_uid_code`。

文件：`apps/web/src/pages/Promotion.tsx`

### 3.3 参数缓存

在根组件路由变化时解析 URL：

- `club_invite`（优先）
- `invite_uid`（仅兼容旧链接）

并写入：

- `mirror_pending_invite_uid`（登录时读，传 `invite_uid_code`）
- `club_invite`（页面展示缓存）

文件：

- `apps/web/src/utils/inviteParams.ts`
- `apps/web/src/hooks/usePersistInviteParams.ts`

### 3.4 登录消费

邮箱登录与钱包登录都会从缓存读取并透传：

- `invite_uid_code`

说明：

- 邮箱登录页已移除“邀请码输入框”。
- 作品邀请码 `invite_code` 仅由 URL/缓存进入 `signIn` 链路，不参与登录请求。

文件：

- `apps/web/src/pages/EmailLogin.tsx`
- `apps/web/src/hooks/useWallet.ts`

登录成功后：

- 清理 `pendingInviteUid`。

---

## 4. 邀请链接场景下的登录回跳

当用户在作品详情页触发登录弹窗并选择邮箱登录时：

1. 跳转到邮箱页时带 `redirect`（当前页路径）。
2. 同时通过路由 state 标记 `backOnSuccess=true`。
3. 登录成功后优先 `history back` 回原详情页；无法回退时才按 `redirect`（非法则 `/`）。

涉及文件：

- `apps/web/src/App.tsx`
- `apps/web/src/pages/EmailLogin.tsx`

---

## 5. 与后端约定（当前前端遵循）

1. 不再单独调用 `applyInviteCode`。
2. 作品签到通过 `signIn` 可选带 `invite_code`（或兼容 `work_invite_code`）。
3. Club 邀请通过 `club_invite` 入站，登录时传 `invite_uid_code`。
4. 生成邀请链接不再依赖用户 ID，不再拼 `invite_uid`。

---

## 6. 关键代码索引

- 作品邀请链接生成：
  - `packages/utils/src/link.ts`
  - `apps/web/src/pages/Home.tsx`
  - `apps/web/src/pages/WorkDetail.tsx`
  - `apps/web/src/components/WorkDetail/Layouts.tsx`

- Club 邀请链接生成与缓存：
  - `apps/web/src/pages/Promotion.tsx`
  - `apps/web/src/utils/inviteParams.ts`
  - `apps/web/src/hooks/usePersistInviteParams.ts`

- 登录消费邀请码：
  - `apps/web/src/pages/EmailLogin.tsx`
  - `apps/web/src/hooks/useWallet.ts`

- 作品签到消费邀请码：
  - `apps/web/src/components/WorkDetail/Layouts.tsx`
  - `apps/web/src/components/Modals/WorkDetailModals.tsx`

---

## 7. 自测建议

1. 从 Promotion 页复制链接，确认形如 `/?club_invite=15HjS6`。
2. 未登录打开 `club_invite` 链接后执行邮箱/钱包登录，抓包确认带 `invite_uid_code=15HjS6`。
3. 邮箱登录请求抓包确认不带 `work_invite_code`。
4. 从首页/作品详情复制作品邀请链接，确认 URL 仅含 `invite_code`，不含 `invite_uid`。
5. 未登录打开带 `invite_code` 的作品链接，登录后签到，抓包确认 `signIn` 带 `invite_code`。
6. 邮箱登录回到详情页后，点击返回应回到首页，不应回到邮箱页。

---

## 8. 移动端对齐（apps/mobile）

为避免 Web / Mobile 邀请与错误处理逻辑分叉，移动端已同步以下规则：

1. 登录只消费 Club 邀请码
- 来源：URL `club_invite`（持久化后登录时传 `invite_uid_code`）。
- 不再在登录请求里传 `work_invite_code`。

2. 邮箱登录页不再展示邀请码输入框
- 邀请码输入完全由 URL 参数与本地缓存驱动，避免手输造成歧义。

3. 作品签到消费作品邀请码
- 从 URL `invite_code` 持久化到本地。
- `POST /arts/work/signIn` 时可选携带 `invite_code`。
- 签到成功后清理 `pendingWorkInviteCode`。

4. 错误码统一走 `@mirror/api`
- 统一错误工具：`packages/api/src/error.ts`
- 统一错误码：
  - `503`（发送验证码过于频繁）
  - `20054`（每日新增作品签到达上限）
  - `30013`（`invite_uid_code` 非法）
- 当登录遇到 `30013` 时，会清理本地 `pendingInviteUid`，避免重试持续失败。
