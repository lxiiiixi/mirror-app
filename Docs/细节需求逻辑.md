> 在这里记录一些很细节的开发过程中容易遗漏的小需求，对应代码中的特定位置，需要注意修改什么，在这里做一个简单的记录。

## 作品详情页 - 语言选择器对作品语言的切换

- **默认选中**：打开作品详情页时，选择器默认选中的是**当前全局语言**（i18n.resolvedLanguage / i18n.language），通过 `i18nLanguageToSelectValue` 转成与接口一致的 key（zh / en / zh_hant）。不再固定为英文。
- **不修改全局语言**：选择器只切换**当前作品**的展示语言（封面、标题、作者、简介等多语言字段），不调用 `i18n.changeLanguage`，不写 `localStorage['user-lang']`。状态由页面内 `contentLang` 维护，仅影响 `resolveLocalizedText(..., languageSelectValueToI18n(contentLang))` 的展示。
- **可选语言来自接口**：选项根据接口返回的**有内容的语言**展示。通过 `getAvailableContentLanguages(data)` 从 `work_name` / `work_cover_url` / `work_creator_name` / `work_description` 中收集至少有一个非空值的 key，传给 `LanguageSelect` 的 `availableLanguages`，只展示这些选项。
- **空内容回退**：展示时用 `resolveLocalizedText(value, languageSelectValueToI18n(contentLang))`；若当前选中语言对应内容为空字符串，`resolveLocalizedText` 内部会按优先级回退到第一个非空语言版本，避免出现空白。
- **数据加载后同步**：当作品接口数据加载完成后，若当前 `contentLang` 不在本次接口的可用语言列表中，会自动将 `contentLang` 设为第一个可用语言，保证选择器与展示一致。

涉及文件：

- `apps/web/src/components/WorkDetail/languageSelectUtils.ts`：`i18nLanguageToSelectValue`、`languageSelectValueToI18n`、`getAvailableContentLanguages`、`getLanguageOptions`
- `apps/web/src/components/WorkDetail/LanguageSelect.tsx`：受控 value + `availableLanguages`，不再依赖 i18n
- `apps/web/src/components/WorkDetail/ProductCover.tsx`：接收 `contentLang`、`onContentLangChange`、`availableLanguages`，不再调用 i18n
- `apps/web/src/pages/WorkDetail.tsx`：`contentLang` 状态、用 `contentLang` 解析封面/标题/作者/简介并传给 ProductCover，数据加载后校正 `contentLang`

---

## 推广链接点击统计（/work/track）

- **时机**：应用**首屏加载**时，若当前 URL 带有 `invite_uid` 或 `invite_code`，上报一次「推广链接点击」（不限于作品详情页，任意带邀请参数的落地页都会统计）。
- **接口**：`GET /arts/work/track`，query 传 `invite_uid`、`invite_code`（与 arts-app 一致），用于统计邀请带来的访问与转化。
- **行为**：仅在该次加载时上报一次（用 ref 标记已上报，避免重复）；无邀请参数则不请求。不依赖登录态（接口 auth: none）。

涉及文件：

- `apps/web/src/hooks/useTrackPromoClick.ts`：Hook，根据 `useLocation().search` 解析 `invite_uid` / `invite_code`，有则调用 `artsApiClient.work.trackPromoClick(...)`，只上报一次。
- `apps/web/src/App.tsx`：在根组件中调用 `useTrackPromoClick()`，保证一进入应用就判断。
- `packages/api`：`WorkTrackPromoParams` 支持 `invite_uid`、`invite_code`（与 `promo_code` 并存兼容）

---

## 邀请绑定（Club 邀请 + 作品邀请）

- **两种独立关系**：
  - **Club 邀请**：链接带 `club_invite`（如 `...?club_invite=15HjS6`），登录时传 `invite_uid_code=15HjS6`。
  - **作品邀请**：链接带 `invite_code`（如 `...?invite_code=00000X`），签到时传 `invite_code`（`signIn`）。
- **流程**：每次进入应用时根据当前 URL 解析邀请参数并写入本地缓存（避免刷新或跳转后丢失）：
  - `club_invite`（兼容旧 `invite_uid`）-> `pendingInviteUid`（登录消费）
  - `invite_code` -> `pendingWorkInviteCode`（签到消费）
- **登录行为**：钱包/邮箱登录只传 `invite_uid_code`（来自 `pendingInviteUid`）；登录成功后清理 `pendingInviteUid`。
- **邮箱页交互**：邮箱登录页已移除邀请码输入框；作品邀请码仅通过 URL/缓存参与后续签到，不参与登录请求。
- **签到行为**：`POST /arts/work/signIn` 可选带 `invite_code`，签到成功后清理 `pendingWorkInviteCode`。
- **链接生成规则**：所有邀请链接生成处均不再拼接 `invite_uid`（用户 ID）。

涉及文件：

- `apps/web/src/utils/inviteParams.ts`：缓存 key、`persistInviteParamsFromSearch`、`getPendingInviteParams`、`clearPendingInviteUid`
- `apps/web/src/hooks/usePersistInviteParams.ts`：在 App 内根据 `location.search` 持久化邀请参数
- `apps/web/src/pages/Promotion.tsx`：从 `/arts/node/inviteInfo` 读取 `invite_code` 并生成 `club_invite` 链接
- `apps/web/src/hooks/useWallet.ts`：`signInWithWallet` 读取 pending 并传 `invite_uid_code`
- `apps/web/src/pages/EmailLogin.tsx`：登录时只传 `invite_uid_code`；不再提供邀请码输入框
