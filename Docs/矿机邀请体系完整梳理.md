现在我已经掌握了完整的业务逻辑。下面给你一个深入的产品和功能实现角度的分析。

---

## 矿机邀请体系完整梳理（产品 + 技术）

### 一、产品全景：VIP 节点经济模型

这是一个以 **VIP 节点（矿机）** 为核心的用户增长和代币挖矿体系，整体包含三个核心子系统：

```
┌─────────────────────────────────────────────────┐
│                   用户增长飞轮                     │
│                                                   │
│  ① 购买 VIP 节点 → ② 节点挖矿产出 ENT              │
│       ↑                    ↓                      │
│  ④ 佣金激励 ←── ③ 邀请新用户购买 VIP               │
│                                                   │
└─────────────────────────────────────────────────┘
```

### 二、三个核心子系统详解

#### 子系统 1：VIP 节点购买

**产品逻辑**：用户花 USDT 购买 VIP 节点（可理解为矿机），节点按「批次/阶梯」(tier) 定价，越早买越便宜（类似 IDO 的阶梯发售）。

**实现流程**（以 Solana 链为例）：

```
用户选购数量 → POST /node/quote (获取报价单)
           → 前端用 Solana SDK 签名 USDT 转账交易
           → POST /node/send (提交签名交易给后端广播)
           → GET /node/tx/:signature (轮询交易状态)
           → 交易成功 → 节点入账
```

**关键接口**：

| 接口                              | 作用                                       |
| --------------------------------- | ------------------------------------------ |
| `GET /node/nodeInfo`              | 获取节点基本信息（总量、算力、ENT 发行量） |
| `GET /node/:id/current_tier_info` | 获取当前批次价格、剩余量                   |
| `POST /node/quote`                | 生成报价单（含 quote_id、金额、过期时间）  |
| `POST /node/send`                 | 提交已签名交易                             |
| `GET /node/tx/:sig`               | 查询交易状态（pending → success/failed）   |

**前端实现**（`arts-app/src/pages/mining/index.vue`）：

- 用 `useNodeTiers` hook 获取当前阶梯价格和剩余量
- 数量选择支持 10/20/30/40/50 快捷按钮和 ±1 微调
- 有满赠规则：买 20 送 2、买 30 送 4、买 50 送 7、买 100 送 15
- 购买后轮询 `searchTxStatus` 每 2 秒查一次直到 success/failed

#### 子系统 2：节点挖矿（ENT 产出）

**产品逻辑**：购买 VIP 节点后自动参与挖矿，系统按**周期(cycle)** 在**批次(batch)** 内产出 ENT 代币。用户可以领取（claim）奖励。

**挖矿收益结构**（从 `Mining.vue` 的 UI 可以看出）：

| 收益类型     | 说明                                                   |
| ------------ | ------------------------------------------------------ |
| 基础挖矿收益 | `today_base_mining_reward` — 节点算力产出              |
| 直推收益     | `today_invite_reward` — 邀请的人也买了节点，你获得佣金 |
| 等级分红     | `today_level_bonus_reward` — VIP 等级越高，分红越多    |
| 销毁收益     | 暂未上线（Coming Soon）                                |

**关键接口**：

| 接口                            | 作用                                    |
| ------------------------------- | --------------------------------------- |
| `GET /node/mining/rewards`      | 获取挖矿奖励详情                        |
| `POST /node/mining/claim`       | 领取奖励（链上操作，返回 tx_signature） |
| `GET /node/mining/claimHistory` | 领取历史                                |
| `GET /node/mining/batches`      | 批次列表                                |
| `GET /node/mining/cycles`       | 周期列表                                |

#### 子系统 3：邀请体系（这是你重点关注的部分）

这是最复杂的部分。系统里有**两套独立的邀请码**，你的文档已经说明了：

##### A. 用户会员邀请码（club_invite）

**产品目的**：建立全局的用户上下级关系（类似推广分销），上级可以从下级的 VIP 购买中获得佣金。

**码的生成**：

- 接口：`GET /node/inviteInfo` → 返回 `invite_code`（62 进制编码，如 `1gT5Kx`）
- 码由后端根据用户 UID 用 `UidToInviteCode(uid)` 算法生成
- 每个用户有且仅有一个

**链接的拼装**：

```
{origin}/?club_invite={invite_code}
// 例如: https://mirror.xyz/?club_invite=1gT5Kx
```

在 arts-app 中是：

```53:53:/Users/liuxi/Developer/Products/Mirror/arts-app/src/pages/promotion/index.vue
const inviteUrlPath = ref(`${config.origin}/pages/home/index?club_invite=`)
```

**码的消费有两条路径**：

**路径 1：新用户注册时自动绑定（登录接口）**

```
新用户打开邀请链接
  → 首页 onShow 把 club_invite 存入 localStorage
  → 路由跳转时 route hook 自动带上 club_invite 参数
  → 用户连接钱包/邮箱登录
  → 登录接口自动带上 invite_uid_code = localStorage.club_invite
  → 后端：如果是新注册用户，自动绑定上下级关系
  → 登录成功 → 清除 localStorage.club_invite + 清除 URL 参数
```

**路径 2：已登录用户手动绑定（推广页）**

```
已登录用户访问推广页
  → GET /user/check → 检查 is_invite（是否已绑定上级）
  → 如果没有绑定 && 有 inviteCode → 显示「绑定上级」按钮
  → 点击按钮 → POST /user/bind { code: inviteCode }
  → 后端：绑定上下级关系（一次性，不可更改）
  → 错误码 427 表示已经绑定过
```

**佣金收益**：

- 接口：`GET /user/commissionHistory` — 佣金记录
- 接口：`GET /user/levelProgress` — 等级进度（返回 `direct_invites`、`indirect_invites`）
- `GET /node/inviteInfo` 返回 `total_invites`（邀请总人数）和 `total_rewards`（累计佣金）

##### B. 作品邀请码（work_invite_code）

**产品目的**：建立**单个作品维度**的邀请关系，不影响全局上下级。

| 对比项       | 用户会员邀请码         | 作品邀请码                       |
| ------------ | ---------------------- | -------------------------------- |
| 生成接口     | `GET /node/inviteInfo` | `POST /work/generateInviteCode`  |
| 绑定时机     | 登录时 / 手动绑定      | 首次签到该作品时                 |
| 绑定接口     | `POST /user/bind`      | `POST /work/signIn`（隐式绑定）  |
| 限制         | 每人只能绑一次上级     | 每个作品独立，已签到过不能被邀请 |
| URL 参数名   | `club_invite`          | `invite_code`                    |
| 登录接口参数 | `invite_uid_code`      | `work_invite_code`               |

### 三、VIP 等级体系

VIP 等级不只是头衔，直接影响挖矿收益和佣金比例：

**升级条件**（从 `UserLevelProgressResponseData` 推断）：

| 等级   | 条件                                       |
| ------ | ------------------------------------------ |
| VIP 0  | 购买了节点                                 |
| VIP 1+ | 需要邀请一定数量的 VIP 用户 + 团队规模达标 |

**等级进度 UI**（`Mining.vue`）：

- 进度条 1：邀请 VIP 用户数量进度（`invitesCurrent / invitesRequired`）
- 进度条 2：团队有效用户数量进度（`teamCurrent / teamRequired`）

**等级收益体现**：

- 基础挖矿：`节点算力 × 节点数量`
- 邀请佣金：`直推佣金 + 间推佣金`（比例如 10-15%）
- 等级分红：`today_level_bonus_reward`（VIP 等级越高分红越多）

### 四、整体数据流图

```
用户 A（推广者）                         用户 B（被邀请者）
─────────────                          ─────────────
GET /node/inviteInfo
  → invite_code: "1gT5Kx"

拼接链接并分享 ─────────────────────────→ 打开链接
  club_invite=1gT5Kx                    localStorage.setItem('club_invite','1gT5Kx')

                                       连接钱包/邮箱登录
                                         → invite_uid_code: "1gT5Kx"
                                         → 后端绑定 B 的上级为 A

                                       购买 VIP 节点
                                         → POST /node/quote → send
                                         → A 获得佣金收益（直推）

                                       B 再邀请 C 购买
                                         → A 获得佣金收益（间推）
                                         → B 获得佣金收益（直推）

A 在推广页查看:
  GET /node/inviteInfo → total_invites, total_rewards
  GET /user/levelProgress → direct_invites, indirect_invites
  GET /user/commissionHistory → 佣金明细
```

### 五、你的 mirror-app 中目前的实现状态

| 功能模块                 | 状态      | 说明                                         |
| ------------------------ | --------- | -------------------------------------------- |
| 邀请链接生成             | ✅ 已实现 | `inviteBase + inviteCode`                    |
| club_invite 持久化       | ✅ 已实现 | `inviteParams.ts` + `usePersistInviteParams` |
| 登录时带 invite_uid_code | ✅ 已实现 | `getPendingInviteParams()`                   |
| 手动绑定上级             | ✅ 刚修复 | `POST /user/bind { code }`                   |
| is_invite 校验           | ✅ 刚修复 | `checkCanBind` → `GET /user/check`           |
| 邀请人数/佣金展示        | ⚠️ 需确认 | `today`/`total` 字段名待验证                 |
| VIP 购买流程             | 需查看    | `VipPurchase.tsx`                            |
| 挖矿奖励/领取            | 需查看    | Mining 相关页面                              |

如果你需要我进一步深入某个具体子系统的实现细节，或者对比 arts-app 和 mirror-app 之间某个环节的差异，可以告诉我。
